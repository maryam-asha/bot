# السيناريو الجديد للبوت - YourVoiceBot

## 🎯 نظرة عامة على تدفق العمل

تم إعادة تصميم البوت ليطبق سيناريو محدد ومتسلسل يبدأ بالمصادقة وينتهي بتقديم الطلبات.

## 🔐 1. بدء البوت والتحقق من المصادقة

### عند الضغط على Start:
1. **فحص حالة المصادقة**: البوت يتحقق من وجود توكن صالح
2. **إذا كان التوكن صالح**: يتم توجيه المستخدم مباشرة لقائمة الخدمات
3. **إذا كان التوكن غير موجود أو منتهي الصلاحية**: يتم طلب رقم الهاتف

### عملية المصادقة:
- **طلب رقم الهاتف**: يجب أن يبدأ بـ `09` ويتكون من 8 أرقام بعد البادئة
- **إرسال رمز التحقق**: يتم استدعاء `request_otp`
- **التحقق من الرمز**: يتم استدعاء `login_otp`
- **تخزين التوكن**: يتم حفظ التوكن مع تاريخ الإنشاء
- **انتهاء الصلاحية**: التوكن ينتهي بعد يومين من عدم الاستخدام

## 🚀 2. قائمة الخدمات (Service Menu)

### الخيارات المتاحة:
- **طلباتي**: عرض الطلبات الموجودة
- **تقديم طلب**: بدء عملية طلب جديد
- **عودة للقائمة الرئيسية**: العودة للقائمة الرئيسية

## 📋 3. عرض الطلبات (My Requests)

### عند اختيار "طلباتي":
1. **استدعاء API**: `get_user_requests` لجلب قائمة الطلبات
2. **عرض الصفحات**: تقسيم الطلبات على صفحات (5 طلبات لكل صفحة)
3. **التنقل**: أزرار "السابق" و "التالي" للتنقل بين الصفحات
4. **عرض التفاصيل**: إمكانية عرض تفاصيل طلب محدد

### عرض الطلب:
- **استدعاء API**: `get_user_request_info` لعرض تفاصيل الطلب
- **التنقل**: إمكانية التنقل بين الطلبات المختلفة

## 📝 4. تقديم طلب جديد - التدفق العام

### ⚠️ مهم: لا يوجد محتوى ثابت
جميع القيم تأتي من API لأنها قد تتغير في كل استدعاء.

### الخطوات:
1. **اختيار الجهة الرئيسية**: استدعاء `get_parent_sides`
2. **اختيار الجهات الفرعية**: استدعاء `get_side_children` بشكل متكرر
   - يتم التكرار حسب قيمة `stop_level`
   - أو حتى التأكد من أن الجهة تقبل الطلبات عبر `disable_request`
3. **اختيار نوع الطلب**: استدعاء `get_request_type`
4. **اختيار المواضيع**: استدعاء `get_request_type_subjects`

## 🔧 5. الحالات الخاصة حسب نوع الطلب

### إذا كان النوع "service":
1. **استدعاء فئات الخدمات**: `get_service_categories`
2. **اختيار الخدمة الفرعية**: `get_services_for_category`
3. **إرسال المعلومات**: الجهة + الخدمة إلى `get_form_data`

### إذا كان النوع "other":
1. **استدعاء المواضيع**: `get_other_request_type_subjects`
2. **إرسال التفاصيل**: إلى `get_form_data`

### إذا لم يكن "service" أو "other":
- **استدعاء النموذج مباشرة**: `get_form_data`

## 📋 6. معالجة النموذج

### عند استرجاع النموذج:
1. **المرور على الحقول**: واحد تلو الآخر بالترتيب
2. **التحقق من الصحة**: حسب نوع كل حقل
3. **الحركة للأمام**: تخطي الحقول غير المطلوبة
4. **الحركة للخلف**: تعديل القيم السابقة
5. **رسالة التأكيد**: عرض جميع الحقول للمراجعة
6. **إرسال الطلب**: استدعاء `submit_complaint`
7. **العودة للقائمة الرئيسية**: لإرسال طلب آخر أو عرض الطلبات

## 🔐 7. إدارة المصادقة (Auth)

### الميزات:
- **المصادقة في البداية**: مطلوبة عند بدء البوت
- **تسجيل النشاط**: تحديث التوكن في كل خطوة
- **انتهاء الصلاحية**: حذف التوكن بعد يومين من عدم الاستخدام
- **إعادة المصادقة**: مطلوبة عند انتهاء صلاحية التوكن

## 🏗️ 8. البنية التقنية

### الملفات المحدثة:
- `config/conversation_states.py`: حالات المحادثة الجديدة
- `handlers/auth_handler.py`: منطق المصادقة المحسن
- `handlers/main_menu_handler.py`: معالجة القائمة الرئيسية
- `handlers/service_menu_handler.py`: معالجة قائمة الخدمات
- `handlers/message_router.py`: توجيه الرسائل
- `bot_with_router.py`: البوت الرئيسي

### حالات المحادثة الجديدة:
```python
# المصادقة
AUTH_CHECK, ENTER_MOBILE, ENTER_OTP

# القوائم
MAIN_MENU, SERVICE_MENU

# عرض الطلبات
VIEW_REQUESTS, VIEW_REQUEST_DETAILS

# تقديم طلب جديد
SELECT_ENTITY, SELECT_ENTITY_CHILDREN, SELECT_REQUEST_TYPE, SELECT_SUBJECTS
SELECT_SERVICE_CATEGORY, SELECT_SERVICE

# ملء النموذج
FILL_FORM, COLLECT_FORM_FIELD, CONFIRM_SUBMISSION
```

## 🚀 9. كيفية التشغيل

### تشغيل البوت:
```bash
python bot_with_router.py
```

### الاختبار:
1. **ابدأ البوت**: `/start`
2. **اختر "سمعنا صوتك"**: سيتم التحقق من المصادقة
3. **إذا لم تكن مصادق عليه**: أدخل رقم الهاتف
4. **اختر "تقديم طلب"**: ابدأ عملية الطلب الجديد
5. **اختر "طلباتي"**: عرض الطلبات الموجودة

## 📊 10. الميزات الجديدة

- ✅ **نظام مصادقة ذكي**: فحص التوكن وتحديث النشاط
- ✅ **تدفق عمل منظم**: خطوات واضحة ومتسلسلة
- ✅ **معالجة الأخطاء**: رسائل واضحة وإعادة المحاولة
- ✅ **التنقل المرن**: العودة والتقدم بين الخطوات
- ✅ **صفحات للطلبات**: عرض منظم مع التنقل
- ✅ **دعم API ديناميكي**: جميع القيم من الخادم

## 🔍 11. استكشاف الأخطاء

### مشاكل شائعة:
1. **البوت لا يستجيب**: تحقق من صحة التوكن
2. **خطأ في API**: تحقق من اتصال الإنترنت
3. **مشكلة في المصادقة**: جرب إعادة تسجيل الدخول
4. **خطأ في النموذج**: تحقق من صحة البيانات المدخلة

### الأوامر المفيدة:
- `/start`: إعادة بدء البوت
- `/cancel`: إلغاء العملية الحالية
- `/help`: عرض المساعدة

---

**البوت الآن يعمل وفق السيناريو المطلوب بالضبط! 🎉**