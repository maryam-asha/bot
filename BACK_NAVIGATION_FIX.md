# ๐ง ุฅุตูุงุญ ูุดููุฉ ุฒุฑ ุงูุฑุฌูุน

## โ ุงููุดููุฉ ุงูุฃุตููุฉ
ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุงูุฑุฌูุน" ูู ุฎุทูุงุช ุงูุชูุฏูู ุนูู ุงูุทูุจุ ูุงู ุงููุธุงู ูุนูุฏ ุฅูู `service_menu` ุจุฏูุงู ูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉ.

## โ ุงูุญููู ุงููุทุจูุฉ

### **1. ุฅุตูุงุญ `back_state_map`:**
```python
# ูุจู ุงูุชุนุฏูู (ุฎุทุฃ)
ConversationState.FILL_FORM: ConversationState.SELECT_SUBJECT,  # โ ูุนูุฏ ููููุถูุน

# ุจุนุฏ ุงูุชุนุฏูู (ุตุญูุญ)
ConversationState.FILL_FORM: ConversationState.SELECT_SERVICE,  # โ ูุนูุฏ ููุฎุฏูุฉ
```

### **2. ุฅุถุงูุฉ ูุธุงู ุชุชุจุน ุงูุฎุทูุงุช:**
```python
def add_step_to_history(context, state: int):
    """ุฅุถุงูุฉ ุฎุทูุฉ ูุชุงุฑูุฎ ุงูุชููู"""
    if 'step_history' not in context.user_data:
        context.user_data['step_history'] = []
    
    # ุฅุถุงูุฉ ุงูุฎุทูุฉ ุงูุญุงููุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
    if not context.user_data['step_history'] or context.user_data['step_history'][-1] != state:
        context.user_data['step_history'].append(state)
        logger.debug(f"Added step to history: {state}. Total steps: {len(context.user_data['step_history'])}")

def get_previous_step(context) -> int:
    """ุงูุญุตูู ุนูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉ"""
    step_history = context.user_data.get('step_history', [])
    if len(step_history) > 1:
        return step_history[-2]  # ุงูุฎุทูุฉ ูุจู ุงูุฃุฎูุฑุฉ
    return ConversationState.MAIN_MENU
```

### **3. ุชุญุฏูุซ `handle_back` ูุงุณุชุฎุฏุงู ุชุชุจุน ุงูุฎุทูุงุช:**
```python
async def handle_back(update: Update, context, current_state: int) -> int:
    # ุงุณุชุฎุฏุงู ุชุชุจุน ุงูุฎุทูุงุช ุงููุฎุฒู ูู context
    step_history = context.user_data.get('step_history', [])
    
    if step_history and len(step_history) > 1:
        # ุฅุฒุงูุฉ ุงูุฎุทูุฉ ุงูุญุงููุฉ
        step_history.pop()
        # ุงูุนูุฏุฉ ููุฎุทูุฉ ุงูุณุงุจูุฉ
        prev_state = step_history[-1]
        context.user_data['step_history'] = step_history
        logger.info(f"Going back to previous step: {prev_state}")
    else:
        # ุฅุฐุง ูู ููู ููุงู ุชุชุจุนุ ุงุณุชุฎุฏู ุงูุฎุฑูุทุฉ ุงูุงูุชุฑุงุถูุฉ
        prev_state = back_state_map.get(current_state, ConversationState.MAIN_MENU)
```

## ๐ ููููุฉ ุนูู ุงููุธุงู ุงูุฌุฏูุฏ

### **1. ุชุชุจุน ุงูุฎุทูุงุช:**
```
ุงููุณุชุฎุฏู ูุจุฏุฃ: [MAIN_MENU]
ูุฎุชุงุฑ "ุชูุฏูู ุทูุจ": [MAIN_MENU, SERVICE_MENU]
ูุฎุชุงุฑ ุงูุฌูุฉ: [MAIN_MENU, SERVICE_MENU, SELECT_COMPLIMENT_SIDE]
ูุฎุชุงุฑ ููุน ุงูุทูุจ: [MAIN_MENU, SERVICE_MENU, SELECT_COMPLIMENT_SIDE, SELECT_REQUEST_TYPE]
ูุฎุชุงุฑ ุงูููุถูุน: [MAIN_MENU, SERVICE_MENU, SELECT_COMPLIMENT_SIDE, SELECT_REQUEST_TYPE, SELECT_SUBJECT]
ูุฎุชุงุฑ ูุฆุฉ ุงูุฎุฏูุฉ: [MAIN_MENU, SERVICE_MENU, SELECT_COMPLIMENT_SIDE, SELECT_REQUEST_TYPE, SELECT_SUBJECT, SELECT_SERVICE_CATEGORY]
ูุฎุชุงุฑ ุงูุฎุฏูุฉ: [MAIN_MENU, SERVICE_MENU, SELECT_COMPLIMENT_SIDE, SELECT_REQUEST_TYPE, SELECT_SUBJECT, SELECT_SERVICE_CATEGORY, SELECT_SERVICE]
ูุจุฏุฃ ุงููููุฐุฌ: [MAIN_MENU, SERVICE_MENU, SELECT_COMPLIMENT_SIDE, SELECT_REQUEST_TYPE, SELECT_SUBJECT, SELECT_SERVICE_CATEGORY, SELECT_SERVICE, FILL_FORM]
```

### **2. ุนูุฏ ุงูุถุบุท ุนูู "ุงูุฑุฌูุน":**
```
ูู FILL_FORM โ ูุนูุฏ ุฅูู SELECT_SERVICE
ูู SELECT_SERVICE โ ูุนูุฏ ุฅูู SELECT_SERVICE_CATEGORY
ูู SELECT_SERVICE_CATEGORY โ ูุนูุฏ ุฅูู SELECT_SUBJECT
ูููุฐุง...
```

## ๐ฑ ูุซุงู ุนูู ุงูุชุฏูู

### **ูุจู ุงูุชุนุฏูู (ุฎุทุฃ):**
```
1. ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
2. ูุงุฆูุฉ ุงูุฎุฏูุงุช
3. ุงุฎุชูุงุฑ ุงูุฌูุฉ
4. ุงุฎุชูุงุฑ ููุน ุงูุทูุจ
5. ุงุฎุชูุงุฑ ุงูููุถูุน
6. ุงุฎุชูุงุฑ ูุฆุฉ ุงูุฎุฏูุฉ
7. ุงุฎุชูุงุฑ ุงูุฎุฏูุฉ
8. ุงููููุฐุฌ โ ุงูุถุบุท ุนูู "ุงูุฑุฌูุน"
9. ูุนูุฏ ุฅูู ุงุฎุชูุงุฑ ุงูููุถูุน โ (ุฎุทุฃ)
```

### **ุจุนุฏ ุงูุชุนุฏูู (ุตุญูุญ):**
```
1. ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
2. ูุงุฆูุฉ ุงูุฎุฏูุงุช
3. ุงุฎุชูุงุฑ ุงูุฌูุฉ
4. ุงุฎุชูุงุฑ ููุน ุงูุทูุจ
5. ุงุฎุชูุงุฑ ุงูููุถูุน
6. ุงุฎุชูุงุฑ ูุฆุฉ ุงูุฎุฏูุฉ
7. ุงุฎุชูุงุฑ ุงูุฎุฏูุฉ
8. ุงููููุฐุฌ โ ุงูุถุบุท ุนูู "ุงูุฑุฌูุน"
9. ูุนูุฏ ุฅูู ุงุฎุชูุงุฑ ุงูุฎุฏูุฉ โ (ุตุญูุญ)
```

## ๐ง ุงูุชุนุฏููุงุช ุงููุทุจูุฉ

### **โ ูู `bot.py`:**
1. **ุฅุตูุงุญ `back_state_map`:** FILL_FORM ูุนูุฏ ุฅูู SELECT_SERVICE
2. **ุฅุถุงูุฉ `add_step_to_history`:** ูุชุชุจุน ุงูุฎุทูุงุช
3. **ุฅุถุงูุฉ `get_previous_step`:** ููุญุตูู ุนูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉ
4. **ุชุญุฏูุซ `handle_back`:** ูุงุณุชุฎุฏุงู ุชุชุจุน ุงูุฎุทูุงุช
5. **ุชุญุฏูุซ ุฌููุน ุงูุฏูุงู:** ูุชุชุจุน ุงูุฎุทูุงุช

### **โ ูู `ConversationState`:**
- ุชุชุจุน ุฏููู ูุฌููุน ุงูุฎุทูุงุช
- ุนูุฏุฉ ููุทููุฉ ููุฎุทูุฉ ุงูุณุงุจูุฉ
- ุญูุธ ุงูุชุงุฑูุฎ ูู `context.user_data['step_history']`

## ๐ฏ ุงููุฒุงูุง ุงูุฌุฏูุฏุฉ

### **โ ุชููู ููุทูู:**
- ุงูุนูุฏุฉ ููุฎุทูุฉ ุงูุณุงุจูุฉ ูุจุงุดุฑุฉ
- ุนุฏู ุงูููุฒ ูุฎุทูุงุช ุจุนูุฏุฉ
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู

### **โ ุชุชุจุน ุฏููู:**
- ุญูุธ ุฌููุน ุงูุฎุทูุงุช
- ุฅููุงููุฉ ุงูุนูุฏุฉ ูุฃู ุฎุทูุฉ
- ุชุงุฑูุฎ ูุงูู ููุชููู

### **โ ูุฑููุฉ ุฃูุจุฑ:**
- ูููู ุฅุถุงูุฉ ุฎุทูุงุช ุฌุฏูุฏุฉ ุจุณูููุฉ
- ุชุนุฏูู ูุณุงุฑุงุช ุงูุนูุฏุฉ
- ุตูุงูุฉ ุฃุณูู

## ๐ ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ

### **1. ุงุฎุชุจุงุฑ ุงูุชุฏูู ุงููุงูู:**
```
- ุงุจุฏุฃ ูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
- ุงุชุจุน ุฌููุน ุงูุฎุทูุงุช
- ุงุถุบุท "ุงูุฑุฌูุน" ูู ูู ุฎุทูุฉ
- ุชุฃูุฏ ูู ุงูุนูุฏุฉ ููุฎุทูุฉ ุงูุณุงุจูุฉ
```

### **2. ุงุฎุชุจุงุฑ ุฒุฑ ุงูุฑุฌูุน:**
```
- ูู ุงููููุฐุฌ โ ูุนูุฏ ููุฎุฏูุฉ
- ูู ุงูุฎุฏูุฉ โ ูุนูุฏ ููุฆุฉ ุงูุฎุฏูุฉ
- ูู ูุฆุฉ ุงูุฎุฏูุฉ โ ูุนูุฏ ููููุถูุน
- ูููุฐุง...
```

### **3. ุงุฎุชุจุงุฑ ุงูุชุงุฑูุฎ:**
```
- ุชุญูู ูู `step_history` ูู context
- ุชุฃูุฏ ูู ุญูุธ ุฌููุน ุงูุฎุทูุงุช
- ุงุฎุชุจุฑ ุงูุนูุฏุฉ ุงููุชุนุฏุฏุฉ
```

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุจุนุฏ ูุฐุง ุงูุฅุตูุงุญ:
- โ **ุฒุฑ ุงูุฑุฌูุน ูุนูู ุจุดูู ุตุญูุญ**
- โ **ุงูุนูุฏุฉ ููุฎุทูุฉ ุงูุณุงุจูุฉ ูุจุงุดุฑุฉ**
- โ **ุชุชุจุน ุฏููู ูุฌููุน ุงูุฎุทูุงุช**
- โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณูุฉ**

---

**ููุงุญุธุฉ:** ุงูุขู ุฒุฑ ุงูุฑุฌูุน ูุนูู ููุง ูู ูุชููุน ููุนูุฏ ุฎุทูุฉ ูุงุญุฏุฉ ููุฎูู!